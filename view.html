<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pear ¬∑ My Recipes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,700;0,900;1,700&display=swap" rel="stylesheet">
<style>
  :root {
    --green:     #3d7a3a;
    --green-mid: #5aaa56;
    --green-lt:  #a8d8a0;
    --cream:     #fdf8ee;
    --yellow:    #f5c842;
    --orange:    #f08030;
    --brown:     #5a3e28;
    --text:      #1e2c1a;
    --radius:    18px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'Fraunces', serif;
    background: var(--cream);
    color: var(--text);
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ BLOBS ‚îÄ‚îÄ */
  .bg-blobs { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
  .blob {
    position: absolute; border-radius: 50%;
    opacity: .13; filter: blur(60px);
    animation: float 12s ease-in-out infinite alternate;
  }
  .blob-1 { width: 500px; height: 500px; background: var(--green-mid); top: -120px; left: -100px; animation-delay: 0s; }
  .blob-2 { width: 400px; height: 400px; background: var(--yellow);    top: 40%;   right: -80px; animation-delay: -4s; }
  .blob-3 { width: 300px; height: 300px; background: var(--orange);    bottom: 5%; left: 20%;    animation-delay: -8s; }
  @keyframes float { from { transform: translate(0,0) scale(1); } to { transform: translate(20px,30px) scale(1.06); } }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav {
    position: relative; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 48px;
  }
  .logo {
    display: flex; align-items: center; gap: 12px;
    font-size: 1.7rem; font-weight: 900;
    color: var(--green); text-decoration: none;
  }
  .logo-icon {
    width: 44px; height: 44px; background: var(--green);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; box-shadow: 0 4px 14px rgba(61,122,58,.35);
  }
  .nav-links { display: flex; gap: 8px; }
  .nav-links a {
    padding: 9px 20px; border-radius: 50px;
    font-weight: 700; font-size: .95rem;
    color: var(--green); text-decoration: none;
    transition: background .2s, color .2s;
  }
  .nav-links a:hover { background: var(--green); color: #fff; }
  .nav-links a.active { background: var(--green); color: #fff; }

  /* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
  .page-header {
    position: relative; z-index: 1;
    max-width: 900px; margin: 20px auto 0;
    padding: 0 48px 48px;
  }
  .hero-tag {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--yellow); color: var(--brown);
    font-weight: 800; font-size: .85rem;
    padding: 6px 16px; border-radius: 50px;
    margin-bottom: 18px; letter-spacing: .04em; text-transform: uppercase;
  }
  .page-header h1 {
    font-size: clamp(2rem, 4vw, 3.2rem); font-weight: 900; line-height: 1.1;
    margin-bottom: 12px;
  }
  .page-header h1 em { font-style: italic; color: var(--green); }
  .page-header p { color: #5a6e55; font-size: 1rem; }

  /* ‚îÄ‚îÄ MAIN CARD ‚îÄ‚îÄ */
  .card {
    position: relative; z-index: 1;
    max-width: 900px; margin: 0 auto 80px;
    padding: 0 48px;
  }
  .card-inner {
    background: #fff;
    border-radius: 28px;
    padding: 44px 48px;
    box-shadow: 0 12px 60px rgba(61,122,58,.13), 0 2px 8px rgba(0,0,0,.06);
    border: 1.5px solid rgba(168,216,160,.4);
  }

  /* ‚îÄ‚îÄ RECIPE SELECT ROW ‚îÄ‚îÄ */
  .select-row {
    display: flex; gap: 14px; align-items: center;
    margin-bottom: 32px; flex-wrap: wrap;
  }
  .select-row label {
    font-weight: 800; font-size: .82rem;
    color: var(--green); text-transform: uppercase; letter-spacing: .06em;
    white-space: nowrap;
  }
  select {
    flex: 1; min-width: 200px;
    font-family: 'Fraunces', serif;
    font-size: .98rem; font-weight: 600;
    color: var(--text); background: var(--cream);
    border: 2px solid rgba(168,216,160,.6);
    border-radius: var(--radius);
    padding: 12px 16px; outline: none;
    appearance: none;
    transition: border .2s, box-shadow .2s;
  }
  select:focus {
    border-color: var(--green-mid);
    box-shadow: 0 0 0 4px rgba(90,170,86,.15);
  }
  select:disabled { opacity: .5; cursor: not-allowed; }

  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 13px 26px; border-radius: 50px;
    font-family: 'Fraunces', serif;
    font-weight: 800; font-size: .95rem;
    cursor: pointer; border: none; text-decoration: none;
    transition: transform .18s, box-shadow .18s;
    white-space: nowrap;
  }
  .btn:hover { transform: translateY(-2px); }
  .btn:disabled { opacity: .45; cursor: not-allowed; transform: none; }
  .btn-primary {
    background: var(--green); color: #fff;
    box-shadow: 0 6px 24px rgba(61,122,58,.35);
  }
  .btn-primary:hover:not(:disabled) { box-shadow: 0 10px 32px rgba(61,122,58,.45); }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty-state {
    text-align: center; padding: 48px 0;
    color: #8a9e85;
  }
  .empty-state .empty-icon { font-size: 3.5rem; margin-bottom: 16px; }
  .empty-state h3 { font-size: 1.3rem; color: var(--text); margin-bottom: 8px; }
  .empty-state a { color: var(--green); font-weight: 700; text-decoration: none; }
  .empty-state a:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 1000;
    background: rgba(30,44,26,.55);
    backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    padding: 24px;
    animation: fade-in .2s ease;
  }
  @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

  .modal {
    background: #fff;
    border-radius: 28px;
    width: 100%; max-width: 620px;
    max-height: 88vh; overflow-y: auto;
    padding: 44px;
    position: relative;
    box-shadow: 0 30px 80px rgba(0,0,0,.22);
    animation: slide-up .25s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes slide-up { from { opacity: 0; transform: translateY(30px) scale(.97); } to { opacity: 1; transform: none; } }

  .modal-close {
    position: absolute; top: 20px; right: 24px;
    width: 36px; height: 36px; border-radius: 50%;
    background: var(--cream); border: none; cursor: pointer;
    font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
    color: var(--text); transition: background .2s;
  }
  .modal-close:hover { background: var(--green-lt); }

  .modal-img {
    width: 100%; border-radius: 18px;
    margin-bottom: 28px; display: none;
    object-fit: cover; max-height: 260px;
  }

  .modal h2 {
    font-size: 1.7rem; font-weight: 900;
    margin-bottom: 20px; line-height: 1.2;
  }

  .modal-section-label {
    font-weight: 800; font-size: .78rem;
    color: var(--green); text-transform: uppercase;
    letter-spacing: .07em; margin-bottom: 8px;
    display: block;
  }

  .modal-ingredients {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-bottom: 24px;
  }
  .ingredient-pill {
    background: var(--cream);
    border: 1.5px solid rgba(168,216,160,.7);
    border-radius: 50px;
    padding: 5px 14px; font-size: .87rem; font-weight: 600;
    color: var(--text);
  }

  .modal-steps { margin-bottom: 24px; }
  .step {
    display: flex; gap: 14px; align-items: flex-start;
    margin-bottom: 14px;
  }
  .step-num {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--green); color: #fff;
    font-size: .82rem; font-weight: 900;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 2px;
  }
  .step-text { line-height: 1.6; font-size: .95rem; }

  /* nutrition grid */
  .nutrition-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 10px;
  }
  .nutrition-cell {
    background: var(--cream);
    border: 1.5px solid rgba(168,216,160,.5);
    border-radius: 14px;
    padding: 12px 14px; text-align: center;
  }
  .nutrition-cell .nut-val {
    font-size: 1.1rem; font-weight: 900; color: var(--green);
    display: block; margin-bottom: 2px;
  }
  .nutrition-cell .nut-key {
    font-size: .75rem; color: #8a9e85; font-weight: 700;
    text-transform: uppercase; letter-spacing: .04em;
  }

  .nutrition-loading {
    display: flex; align-items: center; gap: 10px;
    color: #8a9e85; font-size: .9rem;
    padding: 12px 0;
  }
  .nut-spinner {
    width: 18px; height: 18px;
    border: 3px solid rgba(90,170,86,.3);
    border-top-color: var(--green);
    border-radius: 50%; animation: spin .7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  footer {
    position: relative; z-index: 1;
    text-align: center; padding: 10px 48px 48px;
    font-size: .87rem; color: #8a9e85;
  }
  footer a { color: var(--green); font-weight: 700; text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  @media (max-width: 700px) {
    nav { padding: 18px 24px; }
    .page-header, .card { padding: 0 24px; }
    .page-header { margin-top: 10px; padding-bottom: 32px; }
    .card-inner { padding: 28px 24px; }
    .modal { padding: 30px 24px; }
    .select-row { flex-direction: column; align-items: stretch; }
    .select-row label { margin-bottom: 4px; }
  }
</style>
</head>
<body>

<div class="bg-blobs">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>
</div>

<!-- NAV -->
<nav>
  <a href="index.html" class="logo">
    <div class="logo-icon">üçê</div>
    Pear
  </a>
  <div class="nav-links">
    <a href="index.html">Create</a>
    <a href="scan.html">Scan</a>
    <a href="view.html" class="active">My Recipes</a>
  </div>
</nav>

<!-- PAGE HEADER -->
<div class="page-header">
  <div class="hero-tag"><span>üìã</span> Your Saved Recipes</div>
  <h1>All your creations, <em>saved here.</em></h1>
  <p>Select a recipe below to see its ingredients, steps, and full nutrition facts.</p>
</div>

<!-- MAIN CARD -->
<div class="card">
  <div class="card-inner">

    <div class="select-row">
      <label for="recipeSelect">üçΩ Choose a recipe</label>
      <select id="recipeSelect" disabled>
        <option>Loading‚Ä¶</option>
      </select>
      <button class="btn btn-primary" id="viewRecipeBtn" disabled onclick="fetchRecipe()">
        üëÄ View Recipe
      </button>
    </div>

    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="empty-icon">üçê</div>
      <h3>No recipes yet!</h3>
      <p>Head over to the <a href="index.html">Create page</a> to whip up your first recipe.</p>
    </div>

  </div>
</div>

<!-- FOOTER -->
<footer>
  Created by <a href="https://kidslearninglab.com/about">Eshaan Buddhisagar</a> ¬∑
  Part of <a href="https://kidslearninglab.com">Kids Learning Lab</a>
</footer>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" style="display:none;" onclick="handleOverlayClick(event)">
  <div class="modal" id="recipeModal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <img id="modalImage" class="modal-img" alt="Recipe Image">
    <h2 id="modalTitle"></h2>

    <span class="modal-section-label">ü•¶ Ingredients</span>
    <div class="modal-ingredients" id="modalIngredients"></div>

    <span class="modal-section-label">üë©‚Äçüç≥ Steps</span>
    <div class="modal-steps" id="modalSteps"></div>

    <span class="modal-section-label">üìä Nutrition Facts</span>
    <div id="modalNutrition">
      <div class="nutrition-loading"><div class="nut-spinner"></div> Loading nutrition facts‚Ä¶</div>
    </div>
  </div>
</div>

<script>
  const API = 'https://food-gen.onrender.com';

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  /* ‚îÄ‚îÄ load recipe list ‚îÄ‚îÄ */
  async function loadRecipes() {
    const userId  = getCookie('user_id');
    const select  = document.getElementById('recipeSelect');
    const viewBtn = document.getElementById('viewRecipeBtn');
    const empty   = document.getElementById('emptyState');

    if (!userId) {
      select.innerHTML = '<option disabled selected>Create a recipe first to get started.</option>';
      select.disabled  = true;
      viewBtn.disabled = true;
      empty.style.display = 'block';
      return;
    }

    try {
      const res  = await fetch(`${API}/get_recipes?user_id=${userId}`);
      const data = await res.json();

      if (!data.recipes || data.recipes.length === 0) {
        select.innerHTML = '<option disabled selected>No recipes found.</option>';
        select.disabled  = true;
        viewBtn.disabled = true;
        empty.style.display = 'block';
        return;
      }

      select.innerHTML = '';
      data.recipes.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.title;
        opt.textContent = r.title;
        select.appendChild(opt);
      });
      select.disabled  = false;
      viewBtn.disabled = false;

    } catch (e) {
      select.innerHTML = '<option disabled selected>Error loading recipes.</option>';
      select.disabled  = true;
      viewBtn.disabled = true;
    }
  }

  /* ‚îÄ‚îÄ fetch + show recipe ‚îÄ‚îÄ */
  async function fetchRecipe() {
    const userId = getCookie('user_id');
    if (!userId) return;

    const selectedTitle = document.getElementById('recipeSelect').value;
    if (!selectedTitle) return;

    try {
      const res    = await fetch(`${API}/get_recipes?user_id=${userId}`);
      const data   = await res.json();
      const recipe = data.recipes.find(r => r.title === selectedTitle);
      if (!recipe) return alert('Recipe not found.');

      /* ‚îÄ‚îÄ populate modal ‚îÄ‚îÄ */
      document.getElementById('modalTitle').textContent = recipe.title;

      // image
      const safeTitle = encodeURIComponent(recipe.title.replace(/ /g, '_'));
      const img = document.getElementById('modalImage');
      img.src = `${API}/get_image?user_id=${userId}&title=${safeTitle}`;
      img.style.display = 'none';
      img.onload  = () => img.style.display = 'block';
      img.onerror = () => img.style.display = 'none';

      // ingredients as pills
      const ingredients = Array.isArray(recipe.ingredients)
        ? recipe.ingredients
        : recipe.ingredients.split(',').map(s => s.trim());
      document.getElementById('modalIngredients').innerHTML =
        ingredients.map(i => `<span class="ingredient-pill">${i}</span>`).join('');

      // steps as numbered list
      const procedures = Array.isArray(recipe.procedures)
        ? recipe.procedures
        : recipe.procedures.split(',').map(s => s.trim());
      document.getElementById('modalSteps').innerHTML =
        procedures.map((p, n) => `
          <div class="step">
            <div class="step-num">${n + 1}</div>
            <div class="step-text">${p}</div>
          </div>`).join('');

      // reset nutrition
      document.getElementById('modalNutrition').innerHTML =
        '<div class="nutrition-loading"><div class="nut-spinner"></div> Loading nutrition facts‚Ä¶</div>';

      // show modal
      document.getElementById('modalOverlay').style.display = 'flex';
      document.body.style.overflow = 'hidden';

      // async fetch nutrition
      const recipeText = `
Title: ${recipe.title}
Description: ${recipe.description || ''}
Ingredients: ${ingredients.join(', ')}
Procedures: ${procedures.join(', ')}`.trim();

      try {
        const factsRes  = await fetch(`${API}/get_facts`, {
          method:  'POST',
          headers: { 'Content-Type': 'application/json' },
          body:    JSON.stringify({ recipe_text: recipeText })
        });
        const factsData = await factsRes.json();

        if (factsData.facts) {
          const cells = Object.entries(factsData.facts).map(([key, val]) => {
            const label = key
              .replace(/([a-z])([A-Z])/g, '$1 $2')
              .replace(/^./, s => s.toUpperCase());
            return `<div class="nutrition-cell">
              <span class="nut-val">${val}</span>
              <span class="nut-key">${label}</span>
            </div>`;
          }).join('');
          document.getElementById('modalNutrition').innerHTML =
            `<div class="nutrition-grid">${cells}</div>`;
        } else {
          document.getElementById('modalNutrition').innerHTML =
            '<p style="color:#8a9e85; font-size:.9rem;">Nutrition facts unavailable.</p>';
        }
      } catch {
        document.getElementById('modalNutrition').innerHTML =
          '<p style="color:var(--orange); font-size:.9rem;">‚ö†Ô∏è Could not load nutrition facts.</p>';
      }

    } catch (err) {
      alert('Failed to fetch recipe: ' + err.message);
    }
  }

  function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
    document.body.style.overflow = '';
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
  }

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  window.onload = loadRecipes;
</script>
</body>
</html>