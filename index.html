<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recipe Thing</title>
    <link rel="stylesheet" href="style.css">
    <script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

async function ensureUserId() {
  let userId = getCookie("user_id");
  if (!userId) {
    const response = await fetch("/get_id");
    const data = await response.json();
    userId = data.user_id;
    document.cookie = `user_id=${userId}; path=/; max-age=3153600000`; // 100 years
  }
  return userId;
}

window.onload = function () {
  document.getElementById("recipeForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);

    const user_id = await ensureUserId();
    const data = {
      ingredients: formData.get("ingredients").split(",").map(i => i.trim()),
      budget: parseFloat(formData.get("budget")),
      time: parseInt(formData.get("time")),
      serves: parseInt(formData.get("serves")),
      meal_type: formData.get("meal_type"),
      user_id: parseInt(user_id)
    };

    try {
      const response = await fetch("https://food-gen.onrender.com/create_recipe", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.error) {
        document.getElementById("recipeResult").innerHTML = `<p>Error: ${result.error}</p>`;
        return;
      }

      const imageSrc = `/get_image?user_id=${user_id}&title=${encodeURIComponent(result.title.replace(/ /g, "_"))}`;

      document.getElementById("recipeResult").innerHTML = `
        <h2>${result.title}</h2>
        <p><strong>Description:</strong> ${result.description}</p>
        <p><strong>Ingredients:</strong> ${Array.isArray(result.ingredients) ? result.ingredients.join(", ") : result.ingredients}</p>
        <p><strong>Procedures:</strong> ${Array.isArray(result.procedures) ? result.procedures.join(", ") : result.procedures}</p>
        ${result.image_path ? `<img src="${imageSrc}" alt="Recipe Image" onerror="this.onerror=null; this.src='fallback.png';">` : ""}
      `;
    } catch (err) {
      document.getElementById("recipeResult").innerHTML = `<p>Request failed: ${err.message}</p>`;
    }
  });
};
</script>
</head>
<body>
<div style="text-align: center;">
    <img src="pear.png" width="65" style="margin-bottom: 0px; padding-bottom: 0px;">
    <h1>Pear: Recipes Creator</h1>
    <div class="divider"></div>
    <div id="navigation">
        <ul>
            <li><a href="#"><b>Create Recipe</b></a></li>
            <li><a href="#">Scan Image</a></li>
            <li><a href="#">View Recipes</a></li>
        </ul>
    </div>
    <div class="divider"></div>
    <div class="content">
        <div class="form-container">
        <form class="modern-form" id="recipeForm">
          <label for="ingredients">Ingredients you have (comma-separated)</label>
          <input type="text" id="ingredients" name="ingredients" placeholder="e.g., eggs, milk, flour" required>

          <label for="budget">Budget for extra ingredients (USD)</label>
          <input type="number" id="budget" name="budget" step="0.01" placeholder="e.g., 10" required>

          <label for="serves">Number of people to serve</label>
          <input type="number" id="serves" name="serves" placeholder="e.g., 2" required>

          <label for="time">Time available (in minutes)</label>
          <input type="number" id="time" name="time" placeholder="e.g., 30" required>

          <label for="meal_type">Meal type</label>
          <select id="meal_type" name="meal_type" required>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
            <option value="dessert">Dessert</option>
            <option value="dish">Other</option>
          </select><br><br>

          <button type="submit">Generate Recipe</button>
        </form>
        </div>

        <div id="recipeResult"></div>

    </div>
</div>
</body>
</html>